---
phase: 03-integration-and-results
plan: 03
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - src/services/n8nService.ts
  - src/components/generation/ErrorMessage.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Clicking Generuoti sends request to n8n webhook"
    - "Loading overlay appears during generation"
    - "Results gallery shows after successful generation"
    - "Error message shows for 3 seconds then returns to upload"
    - "Regenerate sends new request with same config"
    - "New upload clears everything and returns to start"
  artifacts:
    - path: "src/services/n8nService.ts"
      provides: "API layer for n8n webhook calls"
      exports: ["generateImages"]
    - path: "src/components/generation/ErrorMessage.tsx"
      provides: "Error overlay with auto-dismiss"
      exports: ["ErrorMessage"]
    - path: "src/App.tsx"
      provides: "Full integrated generation flow"
      contains: "useGeneration"
  key_links:
    - from: "src/App.tsx"
      to: "src/hooks/useGeneration.ts"
      via: "hook usage in component"
      pattern: "useGeneration\\("
    - from: "src/App.tsx"
      to: "src/components/generation/LoadingOverlay.tsx"
      via: "conditional render when loading"
      pattern: "status.*===.*loading.*LoadingOverlay"
    - from: "src/App.tsx"
      to: "src/components/generation/ResultsGallery.tsx"
      via: "conditional render when success"
      pattern: "status.*===.*success.*ResultsGallery"
    - from: "src/hooks/useGeneration.ts"
      to: "src/services/n8nService.ts"
      via: "API call"
      pattern: "generateImages\\("
---

<objective>
Wire all Phase 3 components together in App.tsx, create the n8n service layer, add error handling with auto-recovery, and deliver the complete end-to-end generation flow.

Purpose: Complete the full user journey from clicking "Generuoti" through loading, results display, and action handling - the final piece that makes the MVP functional.

Output: Working n8n integration, error handling, and complete App.tsx with all generation states.
</objective>

<execution_context>
@C:\Users\milos\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\milos\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-integration-and-results/03-CONTEXT.md
@.planning/phases/03-integration-and-results/03-RESEARCH.md
@src/App.tsx
@src/types/index.ts
@src/types/generation.ts
@src/hooks/useGeneration.ts
@src/hooks/useImageUpload.ts
@src/constants/ui.ts
@src/constants/api.ts
@src/components/generation/LoadingOverlay.tsx
@src/components/generation/ResultsGallery.tsx
@src/components/generation/ResultsActions.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create n8n service layer</name>
  <files>src/services/n8nService.ts</files>
  <action>
Create src/services/n8nService.ts:

1. Import API_CONFIG from constants/api
2. Import types: Config, UploadedImage from types/index, GenerationResponse from types/generation

3. Helper function imageToBase64(file: File): Promise<string>
   - Return new Promise that uses FileReader.readAsDataURL
   - Resolve with base64 string (data URL)

4. Main function generateImages(config: Config, images: UploadedImage[], signal: AbortSignal): Promise<GenerationResponse>
   - Convert all images to base64 using Promise.all
   - Build request body: {
       avatar: config.avatar?.id,
       scene: config.scene?.id,
       style: config.style?.id,
       images: base64Images
     }
   - POST to API_CONFIG.webhookUrl with:
     - method: 'POST'
     - headers: { 'Content-Type': 'application/json' }
     - body: JSON.stringify(requestBody)
     - signal: signal (for abort/timeout)
   - Check response.ok, throw Error('API_ERROR') if not
   - Parse JSON and return as GenerationResponse

5. Export generateImages

Note: The AbortSignal is passed in from useGeneration hook which combines user abort + timeout signals.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Check function signature matches expected types.
  </verify>
  <done>
n8nService provides generateImages function that POSTs to webhook with base64 images and config.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ErrorMessage component</name>
  <files>src/components/generation/ErrorMessage.tsx</files>
  <action>
Create src/components/generation/ErrorMessage.tsx:

1. Props: { errorType: ErrorType, onDismiss: () => void }

2. Import UI_TEXT from constants/ui, ErrorType from types/generation

3. Map error type to message:
   - 'TIMEOUT' -> UI_TEXT.errors.timeout
   - 'NETWORK' -> UI_TEXT.errors.network
   - 'API_ERROR' -> UI_TEXT.errors.api
   - default -> UI_TEXT.errors.default

4. Auto-dismiss effect (per CONTEXT.md: "Show error for 3 seconds, then auto-return"):
   - useEffect with setTimeout(onDismiss, 3000)
   - Clean up timer on unmount

5. Layout (similar to LoadingOverlay):
   - Fixed full-screen overlay: fixed inset-0 z-50
   - Semi-transparent backdrop: bg-black/40 backdrop-blur-sm
   - Centered modal: flex items-center justify-center
   - White card: bg-white rounded-xl shadow-2xl p-6 max-w-md w-full mx-4

6. Content:
   - Error icon/header row: flex items-center gap-3, red icon (use text emoji or SVG), "Klaida" title
   - Error message text: text-gray-700

Note: No dismiss button needed - auto-dismiss after 3 seconds. User can wait or refresh.
  </action>
  <verify>
Run `npx tsc --noEmit` - should pass.
Check useEffect has proper cleanup.
  </verify>
  <done>
ErrorMessage shows Lithuanian error for 3 seconds then calls onDismiss to return to upload screen.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate all components in App.tsx</name>
  <files>src/App.tsx, src/hooks/useGeneration.ts</files>
  <action>
1. Update src/hooks/useGeneration.ts to use n8nService:
   - Import generateImages from services/n8nService
   - In generate() function, call generateImages(config, images, combinedSignal) instead of direct fetch
   - Pass config and images as parameters to generate() function
   - Update function signature: generate(config: Config, images: UploadedImage[])

2. Rewrite src/App.tsx to integrate full flow:

Imports:
- Add useGeneration hook
- Add LoadingOverlay, ResultsGallery, ResultsActions, ErrorMessage components
- Keep existing imports

State:
- Keep existing: images (from useImageUpload), config
- Add: const { state, generate, cancel, reset } = useGeneration()

Handlers:
- handleGenerate: call generate(config, images)
- handleRegenerate: call generate(config, images) again (same config/images)
- handleNewUpload: call reset(), call clearImages() from useImageUpload hook, reset config to nulls
- handleErrorDismiss: call reset() to return to idle

Render logic:
A) If state.status === 'loading':
   - Render LoadingOverlay on top of existing UI (fixed overlay, content visible but dimmed behind)
   - Pass progress and onCancel={cancel}

B) If state.status === 'error':
   - Render ErrorMessage with errorType and onDismiss={handleErrorDismiss}

C) If state.status === 'success':
   - Replace upload/config UI with results view:
   - ResultsGallery with images={state.results}
   - ResultsActions with onRegenerate and onNewUpload handlers
   - Keep header, change main content

D) If state.status === 'idle':
   - Show existing upload + config UI (current behavior)

Layout considerations:
- Loading overlay is FIXED on top, so content behind is dimmed but visible (per CONTEXT.md)
- Error overlay is similar (fixed on top)
- Results view replaces the main content entirely

Ensure clearImages is destructured from useImageUpload (already exists in hook).
  </action>
  <verify>
Run `npm run dev` and manually verify:
1. App loads in idle state (upload + config visible)
2. All TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
App.tsx orchestrates full generation flow: idle->loading->success/error, with regenerate and new upload working.
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes
2. `npm run dev` starts without errors
3. App shows upload/config on load
4. Clicking "Generuoti" (with valid config+images) starts loading state
5. All imports resolve correctly
6. No console errors on initial load
</verification>

<success_criteria>
- n8nService.generateImages sends POST to webhook with base64 images
- ErrorMessage auto-dismisses after 3 seconds
- App.tsx renders correct state: idle, loading, success, error
- Loading overlay shows on top of dimmed content
- Results replace main content with gallery and actions
- Regenerate re-triggers generation with same config
- New upload clears everything and returns to idle
- All state transitions work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/03-integration-and-results/03-03-SUMMARY.md`
</output>
